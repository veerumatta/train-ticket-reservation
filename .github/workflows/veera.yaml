name: CI/CD Pipeline for Java App (Maven + SonarQube + Snyk + Nexus + Tomcat)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-deploy:
    runs-on: ubuntu-latest

    env:
      NEXUS_USERNAME: ${{ secrets.NEXUS_USERNAME }}
      NEXUS_PASSWORD: ${{ secrets.NEXUS_PASSWORD }}
      NEXUS_SNAPSHOT_URL: ${{ secrets.NEXUS_SNAPSHOT_URL }}
      NEXUS_RELEASE_URL: ${{ secrets.NEXUS_RELEASE_URL }}

    steps:
      # 1Ô∏è‚É£ Checkout code
      - name: Checkout Repository
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Set up Java 17
      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      # 3Ô∏è‚É£ Cache Maven dependencies
      - name: Cache Maven packages
        uses: actions/cache@v4
        with:
          path: ~/.m2
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      # 4Ô∏è‚É£ Create Maven settings.xml with credentials
      - name: Setup Maven settings.xml
        run: |
          cat > settings.xml <<EOL
          <settings xmlns="http://maven.apache.org/SETTINGS/1.0.0"
                    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                    xsi:schemaLocation="http://maven.apache.org/SETTINGS/1.0.0
                                        https://maven.apache.org/xsd/settings-1.0.0.xsd">
            <servers>
              <server>
                <id>nexus</id>
                <username>${NEXUS_USERNAME}</username>
                <password>${NEXUS_PASSWORD}</password>
              </server>
            </servers>
            <mirrors>
              <mirror>
                <id>central</id>
                <name>Maven Central Mirror</name>
                <url>https://repo1.maven.org/maven2/</url>
                <mirrorOf>*</mirrorOf>
              </mirror>
            </mirrors>
          </settings>
          EOL

      # 5Ô∏è‚É£ Build WAR
      - name: Build with Maven
        run: mvn clean package -DskipTests -s settings.xml -U

      # 6Ô∏è‚É£ Set WAR file variable
      - name: Set WAR file
        run: echo "WAR_FILE=$(ls target/*.war)" >> $GITHUB_ENV

      # 7Ô∏è‚É£ SonarQube Analysis
      - name: SonarQube Scan
        run: |
          mvn clean verify sonar:sonar \
            -Dsonar.projectKey=train-ticket-reservation \
            -Dsonar.host.url="${{ secrets.SONAR_HOST_URL }}" \
            -Dsonar.login="${{ secrets.SONAR_TOKEN }}" \
            -s settings.xml -U

      # 8Ô∏è‚É£ Snyk Vulnerability Scan
      - name: Run Snyk to check for vulnerabilities
        uses: snyk/actions/maven@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        continue-on-error: true

      # 9Ô∏è‚É£ Upload WAR to Nexus
      - name: Upload WAR to Nexus
        run: |
          WAR_FILE=$(ls target/*.war)
          echo "WAR_FILE=$WAR_FILE"

          if [ ! -f "$WAR_FILE" ]; then
            echo "WAR file not found!"
            exit 1
          fi

          VERSION=$(basename $WAR_FILE | sed -E 's/.*-([0-9]+.*)\.war/\1/')
          echo "VERSION=$VERSION"

          if [[ "$VERSION" == *"SNAPSHOT"* ]]; then
            REPO_URL="${{ secrets.NEXUS_SNAPSHOT_URL }}"
          else
            REPO_URL="${{ secrets.NEXUS_RELEASE_URL }}"
          fi

          mvn deploy:deploy-file \
            -DgroupId=TrainBook \
            -DartifactId=TrainBook \
            -Dversion=$VERSION \
            -Dpackaging=war \
            -Dfile=$WAR_FILE \
            -DrepositoryId=nexus \
            -Durl=$REPO_URL \
            -Dusername=$NEXUS_USERNAME \
            -Dpassword=$NEXUS_PASSWORD \
            -s settings.xml -U

      # üîü Check Tomcat connection
      - name: Check Tomcat Connection
        run: |
          curl --fail --anyauth -u "${{ secrets.TOMCAT_USER }}:${{ secrets.TOMCAT_PASSWORD }}" \
          "http://${{ secrets.TOMCAT_HOST }}:8080/manager/text/list"

      # 1Ô∏è‚É£1Ô∏è‚É£ Deploy WAR to Tomcat
      - name: Deploy WAR to Tomcat
        run: |
          curl -v -u "${{ secrets.TOMCAT_USER }}:${{ secrets.TOMCAT_PASSWORD }}" \
          -T "$WAR_FILE" \
          "http://${{ secrets.TOMCAT_HOST }}:8080/manager/text/deploy?path=/REDDY&update=true"









          




          


